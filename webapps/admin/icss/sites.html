<div class="inbox-nav-bar no-content-padding"></div>


<div id="inbox-content" class="inbox-body no-content-padding">


	<div class="inbox-side-bar">
		<div class="well no-padding">
		<form class="smart-form no-padding" method="post" action="sites/left" novalidate="novalidate">
			<fieldset>
				<section class="no-padding">
					<label class="label">${m.asString("sites.choose")}</label>
					<label class="select">
						<select class="input-sm choose-sub form-control" id="sites"></select>
					</label>
				</section>
			</fieldset>
		</form>
		</div>
	
		<ul class="inbox-menu-lg">
			<li class="submenu active"><a class="overview-load" href="javascript:void(0);">${m.asString("menu.sites.overview")}</a></li>
			<li class="submenu"><a class="crawl-load" href="javascript:void(0);">${m.asString("menu.sites.crawl")}</a></li>
			<li class="submenu"><a class="page-load" href="javascript:void(0);">${m.asString("menu.sites.page")}</a></li>
			
			<li><br /><br /><li>
			<li class="dd-item" data-id="1">
				<div class="dd-handle create-open">
					<span>${m.asString("menu.sites.create")}</span>
				</div>
			</li>
		</ul>
		

		<div class="air air-bottom inbox-space">
			&nbsp;<a href="javascript:void(0);" rel="tooltip" title="" data-placement="left" data-original-title='${m.asString("menu.sites.remove")}' class="pull-right txt-color-darken"><i class="fa fa-trash-o fa-lg"></i></a>
			<div class="progress progress-micro">
				<div class="progress-bar progress-primary" style="width: 0%;"></div>
			</div>
		</div>

	</div>


	<div class="table-wrap custom-scroll animated fast fadeInRight">
		<!-- ajax will fill this area -->
		LOADING...

	</div>


</div>

<div id="remove-site-confirm" title='${m.asString("sites.remove.title")}' style="display:none">
	<form class="smart-form" id="remove-site-form" method="post" action="sites/" novalidate="novalidate">
		<fieldset style="padding: 0px">	
			<section>
				<label class="label">${m.asString("sites.remove.site")} : <span id="removeSiteId"></span></label>
			</section>
		</fieldset>
	</form>
</div>


<div id="create_site_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content" style="width:70%">
			
			<div class="modal-header"><h5 id="myModalLabel">${m.asString("sites.create")}</h5></div>

			<div class="modal-body">
			<form class="smart-form" id="create_site_form" method="post" action="sites/" novalidate="novalidate">
			<fieldset style="padding: 0px">					
				<section>
					<label class="label">${m.asString("sites.create.siteid")}</label>
					<label class="input">
						<input type="text" id="newSiteId" name="newsid" placeholder="new site id" />
					</label>
				</section>
				<section>
					<label class="label">${m.asString("sites.create.siteurl")}</label>
					<label class="input">
						<input type="text" id="newSiteUrl" name="newurl" placeholder="new site url" />
					</label>
				</section>
			</fieldset>
			</form>
			</div>
			
			<div class="modal-footer">
			  <button class="btn" data-dismiss="modal" aria-hidden="true">${m.asString("buttons.modal.close")}</button>
			  <button class="btn btn-primary" name="create_site">${m.asString("sites.create.button")}</button>
			</div>  

		</div>
	</div>
</div>



<div id="crawl_remove_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			
			<div class="modal-header"><h5 id="myModalLabel">${m.asString("sites.crawl.remove.title")}</h5></div>

			<div class="modal-body">
			<form class="smart-form" id="crawl_remove_form" method="post" action="sites/crawl/remove" novalidate="novalidate">
			<fieldset style="padding: 0px">					
				<section>
					<label class="label">crawlId</label>
					<label class="input">
						<input type="text" name="crawlid" readonly />
					</label>
				</section>
				
				<section>
					<label class="checkbox"><input type="checkbox" name="removeindex" checked="true"/><i></i>${m.asString("sites.crawl.removeindex")}</label>
				</section>
				
			</fieldset>
			</form>
			</div>
			
			<div class="modal-footer">
			  <button class="btn" data-dismiss="modal" aria-hidden="true">${m.asString("buttons.modal.close")}</button>
			  <button class="btn btn-primary" name="crawl_remove">${m.asString("sites.crawl.remove.button")}</button>
			</div>  

		</div>
	</div>
</div>


<div id="crawl_index_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			
			<div class="modal-header"><h5 id="myModalLabel">${m.asString("sites.crawl.index.title")}</h5></div>

			<div class="modal-body">
			<form class="smart-form" id="crawl_index_form" method="post" action="sites/crawl/index" novalidate="novalidate">
			<fieldset style="padding: 0px">					
				<section>
					<label class="label">crawlId</label>
					<label class="input">
						<input type="text" name="crawlid" readonly />
					</label>
					<label class="label">${m.asString("sites.crawl.index.target")}</label>
					<label class="select">
						<select class="input-sm choose-sub form-control" id="crawl_indexers"></select>
					</label>
				</section>
			</fieldset>
			</form>
			</div>
			
			<div class="modal-footer">
			  <button class="btn" data-dismiss="modal" aria-hidden="true">${m.asString("buttons.modal.close")}</button>
			  <button class="btn btn-primary" name="crawl_index">${m.asString("sites.crawl.index.button")}</button>
			</div>  

		</div>
	</div>
</div>

<div id="crawl_capture_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			
			<div class="modal-header"><h5 id="myModalLabel">${m.asString("sites.crawl.capture.title")}</h5></div>

			<div class="modal-body">
			<form class="smart-form" id="crawl_capture_form" method="post" action="sites/crawl/capture" novalidate="novalidate">
			<fieldset style="padding: 0px">					
				<section>
					<label class="label">crawlId</label>
					<label class="input">
						<input type="text" name="crawlid" readonly />
					</label>
				</section>
			</fieldset>
			</form>
			</div>
			
			<div class="modal-footer">
			  <button class="btn" data-dismiss="modal" aria-hidden="true">${m.asString("buttons.modal.close")}</button>
			  <button class="btn btn-primary" name="crawl_capture">${m.asString("sites.crawl.capture.button")}</button>
			</div>  

		</div>
	</div>
</div>

<script type="text/javascript">

	pageSetUp();

	// PAGE RELATED SCRIPTS

	// pagefunction
	var pagefunction = function() {

		function tableHeightSize() {
			if ($('body').hasClass('menu-on-top')) {
				var menuHeight = 68;
				// nav height

				var tableHeight = ($(window).height() - 224) - menuHeight;
				if (tableHeight < (320 - menuHeight)) {
					$('.table-wrap').css('height', (320 - menuHeight) + 'px');
				} else {
					$('.table-wrap').css('height', tableHeight + 'px');
				}

			} else {
				var tableHeight = $(window).height() - 224;
				if (tableHeight < 320) {
					$('.table-wrap').css('height', 320 + 'px');
				} else {
					$('.table-wrap').css('height', tableHeight + 'px');
				}
			}
		}
		// fix table height
		tableHeightSize();

		$(window).resize(function() {
			tableHeightSize() ;
		}) ;

		
		var lastSiteId = '' ;
		var lastMenuHTML = 'overview.html' ;
		
		$.ajax({
			url:'/admin/sites',
			dataType:'json',
			success:function(data){
				for(var idx in data){
					var col = data[idx] ;
					var option = $('<option value="'+col['sid']+'">'+col['name']+'</option>') ;
					option.appendTo($("#sites")) ;
				}
				
				//LOAD INBOX MESSAGES
				loadURL("icss/sites/overview.html", $('#inbox-content > .table-wrap')) ;
				lastSiteId = $("#sites").val() ;
				
			}, 
			error:function(request,status,error){
				console.log('response', request, status, error) ;
			}
		}) ;

		$(".choose-sub").change(function(){
			loadURL("icss/sites/" + lastMenuHTML, $('#inbox-content > .table-wrap')) ;
			lastSiteId = $("#sites").val() ;
		}) ;
		
		$(".fa-trash-o").click(function(){
			$("#remove-site-confirm" ).css('visibility', 'visible') ;
			$("#removeSiteId").html($("#sites option:selected" ).text()) ;
			$("#remove-site-confirm" ).dialog({
				modal: true,
				buttons: {
					"${m.asString('menu.sites.remove')}": function() {
						var removeId = lastSiteId ;
						var win = $( this ) ;
						if (removeId > ' '){
							$.ajax({
								type: "DELETE",
								dataType : 'text', 
								url: "/admin/sites/" + $(".choose-sub").val(),
								data: { }, 
								complete : function(){ 
									// $("#query_url").text(this.url) ;
								}, 
								success :  function(data) {
									$("#sites option:selected").remove();
									loadURL("icss/sites/" + lastMenuHTML, $('#inbox-content > .table-wrap')) ;
									win.dialog( "close" );
								}
							}) ;	
						}
					},
					"${m.asString('buttons.modal.cancel')}": function() {
						$( this ).dialog( "close" );
					}
				}
			});
		}) ;
		
		var _crawlIndexForm = $("#crawl_index_form") ;
		var _indexerId = $("#crawl_indexers") ;
		
		_crawlIndexForm.validate({
			rules : {
				crawl_indexers : { required : true}
			},
			messages : {
				crawl_indexers : {required : "${m.asString('validation.required', 'indexer id')}"}
			},
			submitHandler : function(form) {
				$.ajax({
					type: "POST",
					url: "/admin/sites/" + $("#sites").val() + "/index",
					data: { crawlid: _crawlIndexForm.find("input[name=crawlid]").val(), 
							iid: _indexerId.val() }
				}).done(function( msg ) {
					//  console.log( "Data Saved: " + msg );
				}).success(function( msg ) {
					$("#crawl_index_modal").modal('hide') ;
					loadURL("icss/sites/page.html", $('#inbox-content > .table-wrap')) ;
				});
			},

			// Do not change code below
			errorPlacement : function(error, element) {
				error.insertAfter(element.parent());
			}
		});

		$("#crawl_index_modal button[name=crawl_index]").click(function(){
			_crawlIndexForm.submit() ;
		});
		
		
		var _crawlCaptureForm = $("#crawl_capture_form") ;
		_crawlCaptureForm.validate({
			rules : {
			},
			messages : {
			},
			submitHandler : function(form) {
				$.ajax({
					type: "POST",
					url: "/admin/sites/" + $("#sites").val() + "/capture",
					data: { crawlid: _crawlCaptureForm.find("input[name=crawlid]").val()}
				}).done(function( msg ) {
					//  console.log( "Data Saved: " + msg );
				}).success(function( msg ) {
					$("#crawl_capture_modal").modal('hide') ;
					loadURL("icss/sites/page.html", $('#inbox-content > .table-wrap')) ;
				});
			},

			// Do not change code below
			errorPlacement : function(error, element) {
				error.insertAfter(element.parent());
			}
		});
		$("#crawl_capture_modal button[name=crawl_capture]").click(function(){
			_crawlCaptureForm.submit() ;
		});

		var _crawlRemoveForm = $("#crawl_remove_form") ;
		_crawlRemoveForm.validate({
			rules : {
			},
			messages : {
			},
			submitHandler : function(form) {
				$.ajax({
					type: "POST",
					url: "/admin/sites/" + $("#sites").val() + "/crawllist",
					data: { crawlid: _crawlRemoveForm.find("input[name=crawlid]").val(), removeindex: _crawlRemoveForm.find("input[name=removeindex]").is(":checked")}
				}).done(function( msg ) {
					//  console.log( "Data Saved: " + msg );
				}).success(function( msg ) {
					$("#crawl_remove_modal").modal('hide') ;
					loadURL("icss/sites/page.html", $('#inbox-content > .table-wrap')) ;
				});
			},

			// Do not change code below
			errorPlacement : function(error, element) {
				error.insertAfter(element.parent());
			}
		});
		$("#crawl_remove_modal button[name=crawl_remove]").click(function(){
			_crawlRemoveForm.submit() ;
		});
		
		
		

		$("#create_site_form").validate({
			rules : {
				newsid : { required : true, pattern:"^[a-z][a-z0-9_]*$", minlength : 4, maxlength : 15 }, 
				newurl : { required : true, pattern:"^(file|https?):\/\/([a-z0-9-]+\.)+[a-z0-9]{2,4}.*$", minlength : 10, maxlength : 100 }
			},
			messages : {
				newsid : {required : "${m.asString('validation.required', 'site id')}", pattern : "${m.asString('validation.idpattern')}", minlength : "${m.asString('validation.minlength', 4)}", maxlength:"${m.asString('validation.maxlength', 15)}"}, 
				newurl : {required : "${m.asString('validation.required', 'site url')}", pattern : "${m.asString('validation.idpattern')}", minlength : "${m.asString('validation.minlength', 10)}", maxlength:"${m.asString('validation.maxlength', 100)}"}
			},
			submitHandler : function(form) {
				var newId = $("#newSiteId").val() ;
				$.ajax({
					type: "POST",
					dataType : 'text', 
					url: "/admin/sites/" + newId,
					data: {siteurl : $("#newSiteUrl").val()}, 
					complete : function(){ 
						// $("#query_url").text(this.url) ;
					}, 
					success :  function(data) {
						if ($('#sites option[value="' + newId + '"]').length > 0) $("#sites").val(newId);
						else $("#sites").append('<option value="'+newId+'" selected="selected">'+newId+'</option>');
						loadURL("icss/sites/overview.html", $('#inbox-content > .table-wrap')) ;
						$('#create_site_modal').modal('hide');
					}
				}) ;	
			},

			// Do not change code below
			errorPlacement : function(error, element) {
				error.insertAfter(element.parent());
			}
		});
		
		$("#create_site_modal button[name=create_site]").click(function(){
			$("#create_site_form").submit() ;
		});
		
		$(".create-open").click(function() {
			$('#create_site_modal').modal({});
		});
		

		$("li.submenu").click(function() {
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
		});

		// Buttons (compose mail and inbox load)
		$(".overview-load").click(function() {
			loadURL("icss/sites/overview.html", $('#inbox-content > .table-wrap')) ;
			lastMenuHTML = "overview.html" ;
		});
		$(".crawl-load").click(function() {
			loadURL("icss/sites/crawl.html", $('#inbox-content > .table-wrap')) ;
			lastMenuHTML = "defined.html" ;
		});
		$(".page-load").click(function() {
			loadURL("icss/sites/page.html", $('#inbox-content > .table-wrap')) ;
			lastMenuHTML = "index.html" ;
		});
	};

	pagefunction();
	
</script>
